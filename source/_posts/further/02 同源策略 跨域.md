---
title: 同源策略
date: 2021/11/12
updated: 2021/11/12
comments:
tags:
 - 网络
categories:
 - furtherNotes
layout:
permalink:
meta: true
---

> ajax 引申内容


### 0. 为什么会有同源策略

**简单来说是为了安全**

1.为了防止恶意网页可以获取其他网站的本地数据。

2.为了防止恶意网站[iframe](https://so.csdn.net/so/search?q=iframe&spm=1001.2101.3001.7020)其他网站的时候，获取数据。

3.为了防止恶意网站在自已网站有访问其他网站的权利，以免通过cookie免登，拿到数据。



### 1. 同源策略

指 “协议 + 域名 + 端口” 三者相同

**同源策略限制js能力，其限制的内容有：**

+ Cookie、LocalStorage、indexedDB 等存储型内容

+ DOM 节点

+ AJAX 请求被浏览器拦截

  > 请求能发出去，服务器端能收到请求并正常返回结构，结果被浏览器拦截了



但**所有 src 和 href 属性都不受同源策略限制**，可以请求第三方服务器数据内容



### 2. 什么情况会造成跨域 

当协议、子域名、主域名、端口号中



### 3. 解决跨域的方式

##### 3.1 jsonp：只能解决 get 跨域	

+ 原理：**利用 script 标签的 src 属性不受同源策略限制。** 网页可以得到从其他来源动态产生的 JSON 数据，jsonp 请求一定要对方的服务器做支持才可以。
+ 步骤：
  1. 创建 script 标签      
  2. src 设置 接口 url
  3. 接口参数必须要带一个自定义参数名 不然后台无法返回数据
  4. 通过定义函数名去接收后台返回数据



##### 3.2 CORS：跨域资源共享

+ 原理：**服务器设置 Access-Control-Allow-Origin 响应头后，浏览器会允许跨域请求**
+ 限制：浏览器需要支持 html5 ，可以支持 post put 等方法，兼容ie9 以上

>后台设置：
>
>Access-Control-Allow-Origin：*                          允许所有域名访问
>
>Access-Control-Allow-Origin：http://a.com      只允许 a.com 访问



+ 使用这种方式解决跨域问题，会在发送请求时出现两种情况，分别为 **简单请求** 和 **复杂请求**

  + **简单请求**：使用 GET、HEAD、POST 或者

    ​                    Content-Type 的值仅限于 text\plain、multipart/form-data、application/x-www-form-urlencoded

    >  请求中的任意 XMLHttpRequestUpload 对象均没有注册任何事件监听器
    >
    > 可以使用 XMLHttpRequest.upload 属性监听

  + **复杂请求**：不符合上述两个要求的请求。复杂请求的 cors 请求，会在正式通信之前，增加一次 http 查询请求，称为“预检”请求，该请求时 option 方法的，通过该请求来知道服务器是否允许跨域请求



##### 3.3 postMessage

是 html5 XMLHttpRequest level2 中的 api，且是为数不多的可以跨域操作的 window 属性之一

可以解决：

+ 页面和其打开的新窗口的数据传递
+ 多窗口之间消息传递
+ 页面与嵌套的iframe消息传递
+ 上面三个场景的跨域数据传递

postMessage() 方法允许来自不同源的脚本采用异步方式进行有限的通信，可以实现跨文档、多窗口、跨域消息传递。

`otherWindow.postMessage(message, targetOrigin, [transfer]);`



##### 3.4 websocket

##### 3.5 node 中间件代理

##### 3.6 nginx 反向代理

##### 3.7 window.name + iframe

##### 3.8 location.hash + iframe

##### 3.9  document.domain + iframe

+ 原理：**相同主域名不同子域名下的页面，给页面设置 document.domain 为基础主域，实现同域 **

  > (二级域名相同的请求下  a.text.com  b.text.com),给页面强制添加 document.domain = ‘text.com’ 表示二级域名都相同就可以实现跨域

+ 限制：同域 document 提供的是页面间的互操作，需要载入 iframe 页面

~~~html
// a.html
<body>
 helloa
  <iframe src="http://b.zf1.cn:3000/b.html" frameborder="0" onload="load()" id="frame"></iframe>
  <script>
    document.domain = 'zf1.cn'
    function load() {
      console.log(frame.contentWindow.a);
    }
  </script>
</body>

// b.html
<body>
   hellob
   <script>
     document.domain = 'zf1.cn'
     var a = 100;
   </script>
</body>

~~~















##### 6.4 用Apache做转发（逆向代理），让跨域变成同域











