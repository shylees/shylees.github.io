---
title: tcp三次握手、四次挥手
date: 2022/3/27
updated: 2022/3/27
comments:
tags:
 - 网络
categories:
 - furtherNotes
layout:
permalink:
meta: true
---

>
> 参考链接：
>
> https://juejin.cn/post/6844904070889603085#heading-1
>
> https://juejin.cn/post/6844903625513238541

## 三次握手

#### 为什么要进行三次握手：为了确认对方的发送和接收能力。

#### 主要流程：

<img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/6/26/1643a1dd6df4813b~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp" style="zoom: 40%;float:flet;" >  

#### 为什么不是两次？

根本原因: 无法确认客户端的接收能力。	

如果是两次，你现在发了 SYN 报文想握手，但是这个包**滞留**在了当前的网络中迟迟没有到达，TCP 以为这是丢了包，于是重传，两次握手建立好了连接。

看似没有问题，但是连接关闭后，如果这个**滞留**在网路中的包到达了服务端呢？这时候由于是两次握手，服务端只要接收到然后发送相应的数据包，就默认**建立连接**，但是现在客户端已经断开了。

#### 为什么不是四次？

三次握手的目的是确认双方`发送`和`接收`的能力，那四次握手可以嘛？

当然可以，100 次都可以。但为了解决问题，三次就足够了，再多用处就不大了。

#### 三次握手过程中可以携带数据么？

第三次握手的时候，可以携带。前两次握手不能携带数据。

如果前两次握手能够携带数据，**那么一旦有人想攻击服务器，那么他只需要在第一次握手中的 SYN 报文中放大量数据，那么服务器势必会消耗更多的时间和内存空间去处理这些数据**，增大了服务器被攻击的风险。

第三次握手的时候，客户端已经处于`ESTABLISHED`状态，并且已经能够确认服务器的接收、发送能力正常，这个时候相对安全了，可以携带数据。

#### 同时打开会怎样？

如果双方同时发 `SYN`报文，状态变化会是怎样的呢？

在发送方给接收方发`SYN`报文的同时，接收方也给发送方发`SYN`报文，两个人刚上了!

发完`SYN`，两者的状态都变为`SYN-SENT`。

在各自收到对方的`SYN`后，两者状态都变为`SYN-REVD`。

接着会回复对应的`ACK + SYN`，这个报文在对方接收之后，两者状态一起变为`ESTABLISHED`。

这就是同时打开情况下的状态变迁。




## 四次挥手

<img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/6/26/1643a20296de1ff0~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp" style="zoom:40%;" >	

#### 等待2MSL的意义

如果不等待，客户端直接跑路，当**服务端还有很多数据包要给客户端发**，且还在路上的时候，若客户端的端口此时刚好被新的应用占用，那么就接收到了无用数据包，造成数据包混乱。所以，**最保险的做法是等服务器发来的数据包都死翘翘再启动新的应用。**

- 1 个 MSL 确保四次挥手中**主动关闭方最后的 ACK 报文最终能达到对端**
- 1 个 MSL 确保**对端没有收到 ACK 重传的 FIN 报文可以到达**

这就是等待 2MSL 的意义。

#### 为什么是四次挥手而不是三次？

因为服务端在接收到`FIN`, 往往不会立即返回`FIN`, **必须等到服务端所有的报文都发送完毕了，才能发`FIN`**。因此先发一个`ACK`表示已经收到客户端的`FIN`，延迟一段时间才发`FIN`。这就造成了四次挥手。

如果是三次挥手会有什么问题？

等于**说服务端将`ACK`和`FIN`的发送合并为一次挥手**，这个时候**长时间的延迟**可能会导致客户端误以为`FIN`没有到达客户端，从而让客户端不断的重发`FIN`

#### 同时关闭会怎样？

<img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/23/170723edeb9e8003~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp" style="zoom:67%;" >